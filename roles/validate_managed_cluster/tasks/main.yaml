---

# OPERATOR HEALTH
# Verify all operators are installed and their Deployments are Available
- name: "Operator Health | Red Hat OpenShift AI Operator"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: rhods-operator
    namespace: redhat-ods-operator
    wait: true
    wait_timeout: 300
    wait_condition:
      type: Available
      status: 'True'
  register: rhods_operator_status

- name: "Operator Health | Node Feature Discovery Operator"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: nfd-controller-manager
    namespace: openshift-nfd
    wait: true
    wait_timeout: 300
    wait_condition:
      type: Available
      status: 'True'
  register: nfd_operator_status

- name: "Operator Health | NVIDIA GPU Operator"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: gpu-operator
    namespace: nvidia-gpu-operator
    wait: true
    wait_timeout: 300
    wait_condition:
      type: Available
      status: 'True'
  register: nvidia_operator_status

- name: "Operator Health | OpenShift Serverless Operator"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: knative-openshift
    namespace: openshift-serverless
    wait: true
    wait_timeout: 300
    wait_condition:
      type: Available
      status: 'True'
  register: serverless_operator_status

- name: "Operator Health | OpenShift Service Mesh Operator"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: istio-operator
    namespace: openshift-operators
    wait: true
    wait_timeout: 300
    wait_condition:
      type: Available
      status: 'True'
  register: servicemesh_operator_status


# CONFIGURATION & COMPONENT READINESS - Core Configurations
# All configurations must be in a Ready state
- name: "Core Config | Fetch GPU ClusterPolicy"
  kubernetes.core.k8s_info:
    api_version: nvidia.com/v1
    kind: ClusterPolicy
    name: gpu-cluster-policy
  register: gpu_clusterpolicy_status

- name: "Core Config | Validate GPU ClusterPolicy Ready"
  assert:
    that:
      - gpu_clusterpolicy_status.resources | length > 0
      - gpu_clusterpolicy_status.resources[0].status.state == "ready"
    fail_msg: "GPU ClusterPolicy is not ready. Expected: status.state = ready, Current: {{ gpu_clusterpolicy_status.resources[0].status.state | default('unknown') }}"
    success_msg: "GPU ClusterPolicy is ready (status.state = ready)"

- name: "Core Config | Fetch NFD Instance"
  kubernetes.core.k8s_info:
    api_version: nfd.openshift.io/v1
    kind: NodeFeatureDiscovery
    name: nfd-instance
    namespace: openshift-nfd
  register: nfd_instance_status

- name: "Core Config | Validate NFD Instance Ready"
  assert:
    that:
      - nfd_instance_status.resources | length > 0
      - nfd_instance_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Available') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "NFD Instance is not ready. Expected: status.conditions[Available] = True"
    success_msg: "NFD Instance is ready (status.conditions[Available] = True)"

- name: "Core Config | Fetch DataScienceCluster"
  kubernetes.core.k8s_info:
    api_version: datasciencecluster.opendatahub.io/v1
    kind: DataScienceCluster
    name: default-dsc
  register: dsc_status

- name: "Core Config | Validate DataScienceCluster Exists"
  assert:
    that:
      - dsc_status.resources | length > 0
    fail_msg: "DataScienceCluster 'default-dsc' not found"
    success_msg: "DataScienceCluster 'default-dsc' exists"

- name: "Core Config | Validate DataScienceCluster Ready"
  assert:
    that:
      - dsc_status.resources[0].status.phase == "Ready"
    fail_msg: "DataScienceCluster is not ready. Expected: status.phase = Ready, Current: {{ dsc_status.resources[0].status.phase | default('unknown') }}"
    success_msg: "DataScienceCluster is ready (status.phase = Ready)"


# CONFIGURATION & COMPONENT READINESS - DataScienceCluster Components
# All components must report Ready = True
- name: "DSC Component | Validate Dashboard Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'DashboardReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Dashboard component is not ready (DashboardReady != True)"
    success_msg: "Dashboard component is ready (DashboardReady = True)"

- name: "DSC Component | Validate Workbenches Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'WorkbenchesReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Workbenches component is not ready (WorkbenchesReady != True)"
    success_msg: "Workbenches component is ready (WorkbenchesReady = True)"

- name: "DSC Component | Validate Data Science Pipelines Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'DataSciencePipelinesReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Data Science Pipelines component is not ready (DataSciencePipelinesReady != True)"
    success_msg: "Data Science Pipelines component is ready (DataSciencePipelinesReady = True)"

- name: "DSC Component | Validate CodeFlare Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'CodeFlareReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "CodeFlare component is not ready (CodeFlareReady != True)"
    success_msg: "CodeFlare component is ready (CodeFlareReady = True)"

- name: "DSC Component | Validate KServe Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'KserveReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "KServe component is not ready (KserveReady != True)"
    success_msg: "KServe component is ready (KserveReady = True)"

- name: "DSC Component | Validate Ray Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'RayReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Ray component is not ready (RayReady != True)"
    success_msg: "Ray component is ready (RayReady = True)"

- name: "DSC Component | Validate TrustyAI Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'TrustyAIReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "TrustyAI component is not ready (TrustyAIReady != True)"
    success_msg: "TrustyAI component is ready (TrustyAIReady = True)"

- name: "DSC Component | Validate ModelMesh Serving Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'ModelMeshServingReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "ModelMesh Serving component is not ready (ModelMeshServingReady != True)"
    success_msg: "ModelMesh Serving component is ready (ModelMeshServingReady = True)"

- name: "DSC Component | Validate Kueue Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'KueueReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Kueue component is not ready (KueueReady != True)"
    success_msg: "Kueue component is ready (KueueReady = True)"

- name: "DSC Component | Validate ModelRegistry Ready"
  assert:
    that:
      - dsc_status.resources[0].status.conditions | selectattr('type', 'equalto', 'ModelControllerReady') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "ModelRegistry component is not ready (ModelControllerReady != True)"
    success_msg: "ModelRegistry component is ready (ModelControllerReady = True)"


# GPU VALIDATION - Node Labels
# All GPU nodes must have proper labels applied
- name: "GPU Validation | Fetch All Nodes"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: all_nodes

- name: "GPU Validation | Identify GPU Nodes"
  set_fact:
    gpu_nodes: "{{ all_nodes.resources | selectattr('metadata.labels', 'defined') | selectattr('metadata.labels', 'contains', 'nvidia.com/gpu.present') | list }}"

- name: "GPU Validation | Validate NFD Labels on GPU Nodes"
  assert:
    that:
      - item.metadata.labels is defined
      - "'feature.node.kubernetes.io/pci-10de.present' in item.metadata.labels or 'feature.node.kubernetes.io/pci-0302_10de.present' in item.metadata.labels"
    fail_msg: "GPU node {{ item.metadata.name }} missing NFD labels (feature.node.kubernetes.io/pci-10de.present OR feature.node.kubernetes.io/pci-0302_10de.present)"
    success_msg: "GPU node {{ item.metadata.name }} has NFD labels"
  loop: "{{ gpu_nodes }}"
  when: gpu_nodes | length > 0

- name: "GPU Validation | Validate NVIDIA GPU Operator Labels on GPU Nodes"
  assert:
    that:
      - item.metadata.labels is defined
      - "'nvidia.com/gpu.present' in item.metadata.labels"
      - "'nvidia.com/gpu.count' in item.metadata.labels"
    fail_msg: "GPU node {{ item.metadata.name }} missing NVIDIA GPU Operator labels (nvidia.com/gpu.present, nvidia.com/gpu.count)"
    success_msg: "GPU node {{ item.metadata.name }} has NVIDIA GPU Operator labels (gpu.present, gpu.count)"
  loop: "{{ gpu_nodes }}"
  when: gpu_nodes | length > 0


# GPU VALIDATION - Required Pods
# NFD worker pods and NVIDIA pods must be running
- name: "GPU Validation | Fetch NFD Worker Pods"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: openshift-nfd
    label_selectors:
      - app=nfd-worker
    field_selectors:
      - status.phase=Running
  register: nfd_worker_pods

- name: "GPU Validation | Validate NFD Worker Pods Running"
  assert:
    that:
      - nfd_worker_pods.resources | length > 0
    fail_msg: "No NFD worker pods running in openshift-nfd namespace"
    success_msg: "NFD worker pods running ({{ nfd_worker_pods.resources | length }} pods)"

- name: "GPU Validation | Fetch NVIDIA Driver Pods"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: nvidia-gpu-operator
    label_selectors:
      - app.kubernetes.io/component=nvidia-driver
    field_selectors:
      - status.phase=Running
  register: gpu_driver_pods

- name: "GPU Validation | Validate NVIDIA Driver Pods Running"
  assert:
    that:
      - gpu_driver_pods.resources | length > 0
    fail_msg: "No NVIDIA driver pods running in nvidia-gpu-operator namespace"
    success_msg: "NVIDIA driver pods running ({{ gpu_driver_pods.resources | length }} pods)"
  when: gpu_nodes | length > 0


# NETWORKING
# Service Mesh (Istio) control plane must be healthy
- name: "Networking | Fetch ServiceMeshControlPlane"
  kubernetes.core.k8s_info:
    api_version: maistra.io/v2
    kind: ServiceMeshControlPlane
    namespace: istio-system
  register: smcp_status

- name: "Networking | Validate Service Mesh Control Plane Healthy"
  assert:
    that:
      - smcp_status.resources | length > 0
      - smcp_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Service Mesh control plane is not healthy (Ready != True)"
    success_msg: "Service Mesh (Istio) control plane is healthy (Ready = True)"


# MONITORING & OBSERVABILITY
# GPU metrics available via DCGM exporter
- name: "Monitoring | Fetch DCGM Exporter Pods"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: nvidia-gpu-operator
    label_selectors:
      - app=nvidia-dcgm-exporter
    field_selectors:
      - status.phase=Running
  register: dcgm_exporter_pods

- name: "Monitoring | Validate DCGM Exporter Pods Running"
  assert:
    that:
      - dcgm_exporter_pods.resources | length > 0
    fail_msg: "No DCGM Exporter pods running - GPU metrics may not be available"
    success_msg: "DCGM Exporter pods running ({{ dcgm_exporter_pods.resources | length }} pods) - GPU metrics available"
  when: gpu_nodes | length > 0

# VALIDATION SUMMARY
- name: "Summary | Display Validation Results"
  debug:
    msg:
      - "==============================================================================="
      - "                    CLUSTER VALIDATION SUMMARY"
      - "==============================================================================="
      - ""
      - "OPERATOR HEALTH"
      - "  [✓] Red Hat OpenShift AI"
      - "  [✓] Node Feature Discovery"
      - "  [✓] NVIDIA GPU Operator"
      - "  [✓] OpenShift Serverless"
      - "  [✓] OpenShift Service Mesh"
      - ""
      - "CORE CONFIGURATIONS"
      - "  [✓] DataScienceCluster: {{ dsc_status.resources[0].status.phase | default('unknown') }}"
      - "  [✓] GPU ClusterPolicy: {{ gpu_clusterpolicy_status.resources[0].status.state | default('unknown') }}"
      - "  [✓] NFD Instance: Available"
      - ""
      - "DATASCIENCECLUSTER COMPONENTS"
      - "  [✓] Dashboard"
      - "  [✓] Workbenches"
      - "  [✓] Data Science Pipelines"
      - "  [✓] CodeFlare"
      - "  [✓] KServe"
      - "  [✓] Ray"
      - "  [✓] TrustyAI"
      - "  [✓] ModelMesh Serving"
      - "  [✓] Kueue"
      - "  [✓] ModelRegistry"
      - ""
      - "GPU VALIDATION"
      - "  [✓] GPU Nodes Found: {{ gpu_nodes | length }}"
      - "  [✓] NFD worker pods running: {{ nfd_worker_pods.resources | length }}"
      - "  [✓] NVIDIA driver pods running: {{ gpu_driver_pods.resources | length | default(0) }}"
      - ""
      - "NETWORKING"
      - "  [✓] Service Mesh (Istio) control plane: Healthy"
      - ""
      - "MONITORING & OBSERVABILITY"
      - "  [✓] DCGM Exporter pods running: {{ dcgm_exporter_pods.resources | length | default(0) }}"
